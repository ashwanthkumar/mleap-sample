<html>
<head>
  <title>Finder</title>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" type="text/javascript" ></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js" type="text/javascript" ></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" type="text/javascript" ></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.2/URI.min.js" type="text/javascript" ></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js" type="text/javascript" ></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.0/highcharts.js" type="text/javascript"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>

  <!-- Bootstrap + form validator -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.5/validator.min.js" type="text/javascript"></script>

  <!-- Full calendar plugin -->
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.print.css" rel='stylesheet' media='print'>

  <!-- Bootstrap Select -->
  <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css" rel="stylesheet" type="text/css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

  <!-- Highcharts related CSS -->
  <link href="//cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.0/css/highcharts.css" rel='stylesheet' media='print'>
  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.min.js"></script>

  <style type="text/css">
    body {
      margin: 40px 10px;
      padding: 0;
      font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
      font-size: 14px;
    }
    #calendar {
      max-width: 100%;
      margin: 0 auto;
    }
    .border-right {
        border-right: 1px solid black;
    }

    .stat-block {
        margin: 5px;
        height: 100px;
        border: 1.5px solid black;
    }
    .stat-block header {
      height: 40px;
      font-weight: 700;
      text-transform: uppercase;
      /*background-color: #272727;*/
      padding: 6px 0px 6px 0px;
      border-bottom: 1px solid black;
      text-align: center;
    }
    .stat-block header>h1 {
      margin: 0px;
      font-size: 15px;
      text-shadow: 1px 1px #ffffff;
    }
    .stat-block section {
      text-align: center;
      padding: 10px;
      line-height: 1;
      text-shadow: 1px 1px #ffffff;
    }
    .stat-block section .big {
      margin: 0px;
      font-size: 20px;
    }
    .stat-block section .medium {
      margin: 0px;
      font-size: 15px;
    }
    .stat-block section .small {
      margin: 0px;
      font-size: 10px;
    }
  </style>
</head>
<body>
<div class="page-header">
  <h1><span class="glyphicon glyphicon glyphicon-fire" aria-hidden="true"></span>  Finder</h1>
</div>

<form data-toggle="validator" id="search" role="form">
  <div class="row">
    <div class="col-lg-12">
      <div class="input-group input-group-lg">
          <select class="selectpicker input-group-btn" id="dataset" name="dataset">
            <option value="crawler">Crawled HTML</option>
            <option value="merge-snapshot">Merge Snapshot</option>
          </select>

        <input type="url" class="form-control" id="url" name="url" aria-describedby="url"
               aria-label="Search Finder using a key like URL" placeholder="Search Finder" required/>
        <span class="input-group-btn">
          <button class="btn btn-primary" type="submit" id="go">Go!</button>
        </span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div class="checkbox">
        <label class="checkbox-inline">
          <input type="checkbox" name="showJSON" id="showJSON">Show Metadata (Without Content)
        </label>
      </div>
    </div>
  </div>
</form>

<div class="row">
    <div class="col-lg-7 border-right">
      <div id='calendar'></div>
    </div>
    <div class="col-lg-5">
      <!-- Nav tabs -->
      <ul class="nav nav-pills" role="tablist">
        <li role="presentation" class="active"><a href="#info" aria-controls="info" role="tab" data-toggle="tab">Info</a></li>
        <li role="presentation"><a href="/playground/#/finder" target="_blank" role="tab"><strong>API Playground</strong></a></li>
      </ul>

    <!-- Tab panes -->
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="info">
        <h3>Getting Started</h3>
        <p>You can use any url as crawled by Cannonball from <a target="_blank" href="https://indix.loggly.com/search#terms=Url%20Fetcher&from=-48h&until=-24h&source_group=13759&filter=derived.statusCode%3B200">Loggly</a> and search it here. </p>

        <p>We've HTML data indexed from 1st Oct, 2017 onwards.</p>

        <p class="alert alert-info"><strong>NOTE</strong> - It might take upto 6 hours for the crawled versions to get indexed and become accessible here.</p>

        <h3>Sample Queries</h3>
        <ul>
          <li><a class="sample" data-dataset="crawler" href="#">https://www.snapdeal.com/product/distantsionnoe-zondirovanie-mutnosti-atmosfery/620747505781</a></li>
          <li><a class="sample" data-dataset="crawler" href="#">http://www.amazon.com/</a></li>
          <li><a class="sample" data-dataset="merge-snapshot" href="#">http://www.amazon.in/dp/B00Y2WAE12?psc=1</a></li>
        </ul>

        <h3>Known Issues</h3>
        <p>Sometimes the loading bar would be stuck on the page because the query to the storage is getting delayed. In that case, just refresh the page. </p>
      </div>
    </div>
  </div>

  <hr />

  <div class="row">
    <div class="col-lg-12 text-center">
        Made with <span class="glyphicon glyphicon glyphicon-heart" aria-hidden="true"></span> at Indix.
    </div>
  </div>
</body>

<script>
$('#calendar').fullCalendar({
  header: {
    left: 'prev,next',
    center: 'title',
    right: '',
    navLinks: false, // can click day/week names to navigate views
  },
  views: {
    list: {
      titleFormat: '[Available Versions] - YYYY',
      noEventsMessage: 'Sorry, No versions available. Please check the url again.',
      duration: { year: 5 } // showing all 5 years worth of history in a single page
    }
  },
  defaultView: 'listYear',
  height: 450
});
$('#calendar').hide();

$("#search").on('submit', function(e) {
  e.preventDefault();

  var input = $("#url").val();
  var dataset = $("#dataset").val();
  var request = {
    url: input,
    dataset: dataset
  }
  history.pushState(request, '', '?dataset=' + dataset + '&url=' + encodeURIComponent(request.url));
  
  var loading = bootbox.dialog({
    message: '<div class="text-center"><span class="glyphicon glyphicon glyphicon-search" aria-hidden="true"></span> Please wait while we look for your url in the archives... </div>',
    closeButton: false
  });

  // remove any existing events
  $('#calendar').fullCalendar('removeEventSources');
  $.ajax({
    url: '/v1/search',
    type: 'POST',
    data: JSON.stringify(request),
    success: function(response) {
      loading.modal('hide');
      var showJson = $("input#showJSON")[0].checked
      var events = _.map(response.versions, function(version) {
        return {
          title: request.url,
          start: moment.unix(version / 1000), // since we store epoch in ms
          url: '/v1/raw' + '?version=' + version + '&dataset=' + dataset + '&showJson=' + showJson + '&url=' + encodeURIComponent(request.url),
          allDay: false
        };
      });
      $('#calendar').show();
      $('#calendar').fullCalendar('addEventSource', events );
    },
    contentType: "application/json",
    dataType: "json",
    error: function(response) {
      loading.modal('hide');
      bootbox.alert({
        title: response.status + " - " + response.statusText,
        message: response.responseText,
        backdrop: true
      });
      history.pushState(request, '', '');
    }
  });
});

$(".sample").on('click', function(e) {
  e.preventDefault();
  var sampleUrl = $(e.target).text();
  var dataset = $(e.target).attr('data-dataset');
  $("#url").val(sampleUrl);
  $("#dataset").val(dataset).change();
  $("#search").submit();
});

$("#dataset").change(function(e) {
  var value = $(e.target).val();
  // Hack to always show the JSON on the client side when requested
  if (value != "crawler") $("input#showJSON").prop('checked', true);
});

$("input#showJson").change(function(e) {
  $("#search").validator();
  var url = $("#url").val();
  if(url != "") {
    $("#search").submit();
  }
});

$(window).on("popstate", function(e, data) {
  if (null !== e.originalEvent.state) {
    var state = e.originalEvent.state
    var url = state.url;
    var dataset = state.dataset;
    $("#url").val(url);
    $("#dataset").val(dataset).change();
  }
});

$(document).ready(function() {
  var popped = ('state' in window.history && window.history.state !== null);
  if (popped) {
    var state = window.history.state;
    $("#url").val(state.url);
    $("#dataset").val(state.dataset).change();
  } else {
    var uri = new URI(location.href);
    if(uri.hasQuery("url")) {
      $("#url").val(uri.search(true).url);
      // for a better user experience - when a user
      // comes over via permlink - let's just auto-load
      // the versions for the url
      $("#search").submit();
    }
  }
});

</script>
</html>
